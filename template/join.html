<!DOCTYPE html>
<html>
<head lang="zh">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="http://libs.useso.com/js/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="http://libs.useso.com/js/jquery/2.1.1/jquery.min.js"></script>
    <script src="http://libs.useso.com/js/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <title>加入游戏</title>
    <style>
        .no_empty:empty {
            display: none;
        }
    </style>
    <script>
        status="idle";
        document.addEventListener('DOMContentLoaded',function(){
            window.join_btn=document.getElementById("join_btn");
            window.okay_btn=document.getElementById("okay_btn");
            window.start_btn=document.getElementById("start_btn");
            window.plist=document.getElementById("plist");
            window.nickname=document.getElementById("nickname");
            window.error_div=document.getElementById("error_div");
            setInterval(refresh,1500);
            refresh();
        });
        function refresh(){
            var xhr=new XMLHttpRequest();
            xhr.open("post","/ping");
            xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded;");
            xhr.onreadystatechange=function() {
                if(this.readyState!=4)
                    return;
                if(this.status!=200) {
                    error_div.innerText="在刷新列表时发生了错误 "+this.status;
                    return;
                }
                var response=JSON.parse(this.responseText);
                if(response["error"]) {
                    if(response["error"]=="[start]")
                        window.location.assign("/game");
                    else
                        error_div.innerText=response["error"];
                    return;
                }
                else
                    var pdata=response["plist"];
                plist.innerHTML="";
                for(var pos=0;pos<pdata.length;pos++) {
                    var tmp=document.createElement("span");
                    tmp.className="label label-"+(pdata[pos]["okay"]?"success":"default");
                    tmp.innerText=pdata[pos]["name"];
                    plist.appendChild(tmp);
                }
            };
            xhr.send(
                "status="+status+"&"+
                "name="+encodeURIComponent(nickname.value)
            );
        }
        function join() {
            if(status!="idle") {
                join_btn.innerText="加入";
                status="idle";
                okay_btn.setAttribute('disabled','disabled');
                nickname.removeAttribute("disabled");
            }
            else {
                join_btn.innerText="取消加入";
                status="join";
                okay_btn.removeAttribute("disabled");
                nickname.setAttribute("disabled","disabled");
            }
        }
        function okay() {
            if(status!="okay") {
                okay_btn.innerText="取消准备";
                status="okay";
                join_btn.setAttribute("disabled","disabled");
                start_btn.removeAttribute("disabled");
            }
            else {
                okay_btn.innerText="准备";
                status="join";
                join_btn.removeAttribute("disabled");
                start_btn.setAttribute("disabled","disabled");
            }
        }
        function start() {
            var xhr=new XMLHttpRequest();
            xhr.open("post","/start",true);
            xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded;");
            xhr.onreadystatechange=function() {
                if(this.readyState!=4)
                    return;
                if(this.status!=200) {
                    error_div.innerText="在开始游戏时发生了错误 "+this.status;
                    return;
                }
                if(this.responseText=="[okay]")
                    window.location.assign("/game");
                else
                    error_div.innerText=this.responseText;
            };
            error_div.innerText="请稍候……";
            xhr.send("name="+encodeURIComponent(nickname.value));
        }
    </script>
</head>
<body><div class="container">
    <div class="well well-sm">
        <input placeholder="昵称" class="form-control" style="width: 200px; display: inline !important;" id="nickname">
        <button type="button" class="btn btn-primary" id="join_btn" onclick="join()">加入</button>
        <button type="button" class="btn btn-success" id="okay_btn" onclick="okay()" disabled="disabled">准备</button>
        <button type="button" class="btn btn-danger" id="start_btn" onclick="start()" disabled="disabled">开始</button>
    </div>
    <div class="alert alert-danger no_empty" id="error_div"></div>
    <div class="well well-sm" id="plist"></div>
</div></body>
</html>